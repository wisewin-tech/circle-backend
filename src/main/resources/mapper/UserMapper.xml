<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 【用户】 -->
<mapper namespace="com.wisewin.backend.dao.UserDAO">
    <!--查询用户信息-->
    <select id="getUserById" resultType="com.wisewin.backend.entity.bo.UserBO" parameterType="java.lang.Long">
        select * from ci_user where id=#{id}
    </select>
    <!--添加user-->
    <insert id="addUser" parameterType="com.wisewin.backend.entity.bo.UserBO" useGeneratedKeys="true" keyProperty="id">
        insert into ci_user
        (phone,password,latitude,longitude,certification_status,car_status,user_status,robot_status,create_time)
        values
        (#{phone},#{password},#{latitude},#{longitude},#{certificationStatus},#{carStatus},#{userStatus},#{robotStatus},now())
    </insert>
    <!--添加模块信息-->
    <insert id="addModel" parameterType="com.wisewin.backend.entity.bo.ModelBO" useGeneratedKeys="true"
            keyProperty="id">
        insert into ci_model
        (model,sex,birthday,constellation,height,weight,education,birthplace,
        sex_status,car_certification_status,be_like_count,
        be_super_like_count,super_like_count,name,user_id,describe)
        values
        (#{model},#{sex},#{birthday},#{constellation},#{height},#{weight},#{education},#{birthplace},
        #{sexStatus},#{carCertificationStatus},#{beLikeCount},
        #{beSuperLikeCount},#{superLikeCount},#{name},#{userId},#{describe})
    </insert>
    <!--修改模块信息-->
    <update id="updateUserModel" parameterType="com.wisewin.backend.entity.bo.ModelBO">
        update ci_model
        <set>
            <if test="sex!=null and sex!=''">
                sex=#{sex},
            </if>
            <if test="birthday!=null and birthday!=''">
                birthday=#{birthday},
            </if>
            <if test="constellation!=null and constellation!=''">
                constellation=#{constellation},
            </if>
            <if test="height!=null and height!=''">
                height=#{height},
            </if>
            <if test="weight!=null and weight!=''">
                weight=#{weight},
            </if>
            <if test="education!=null and education!=''">
                education=#{education},
            </if>
            <if test="birthplace!=null and birthplace!=''">
                birthplace=#{birthplace},
            </if>
            <if test="sexStatus!=null and sexStatus!=''">
                sex_status=#{sexStatus},
            </if>
            <if test="carCertificationStatus!=null and carCertificationStatus!=''">
                car_certification_status=#{carCertificationStatus},
            </if>
            <if test="beLikeCount!=null and beLikeCount!=''">
                be_like_count=#{beLikeCount},
            </if>
            <if test="superLikeCount!=null and superLikeCount!=''">
                super_like_count=#{superLikeCount},
            </if>
            <if test="name!=null and name!=''">
                name=#{name},
            </if>
            update_time=now()
        </set>
        where id=#{id}
    </update>

    <!--添加兴趣信息-->
    <insert id="addInterest" parameterType="com.wisewin.backend.entity.bo.UserInterestBO">
        insert into ci_user_interest
        (model_id,type_id,interest_name)
        values
        (#{modelId},#{typeId},#{interestName})
    </insert>

    <sql id="limit">
        limit #{pageSize} offset #{pageOffset}
    </sql>
    <!--分页查询用户列表-->
    <select id="getUserList" parameterType="java.util.Map" resultType="com.wisewin.backend.entity.bo.UserBO">
        select * from ci_user
        <where>
            <if test="phone!=null and phone!=''">AND phone like '%${phone}%'</if>
            <if test="certificationStatus!=null and certificationStatus!=''">AND
                certification_status=#{certificationStatus}
            </if>
            <if test="carStatus!=null and carStatus!=''">AND car_status=#{carStatus}</if>
            <if test="userStatus!=null and userStatus!=''">AND user_status=#{userStatus}</if>
            <if test="robotStatus!=null and robotStatus!=''">AND robot_status=#{robotStatus}</if>
        </where>
        order by create_time desc
        <include refid="limit"/>
    </select>
    <!--查询用户列表条数-->
    <select id="getUserListCount" parameterType="java.util.Map" resultType="java.lang.Integer">
        select count(1) from ci_user
        <where>
            <if test="phone!=null and phone!=''">AND phone like '%${phone}%'</if>
            <if test="certificationStatus!=null and certificationStatus!=''">AND
                certification_status=#{certificationStatus}
            </if>
            <if test="carStatus!=null and carStatus!=''">AND car_status=#{carStatus}</if>
            <if test="userStatus!=null and userStatus!=''">AND user_status=#{userStatus}</if>
            <if test="robotStatus!=null and robotStatus!=''">AND robot_status=#{robotStatus}</if>
        </where>
    </select>
    <!--根据用户查询模式的信息-->
    <select id="getModelByUserId" parameterType="java.lang.Long" resultType="com.wisewin.backend.entity.bo.ModelBO">
        select * from ci_model where user_id=#{userId}
    </select>
    <!--修改用户信息-->
    <update id="updateUser" parameterType="com.wisewin.backend.entity.bo.UserBO">
        update ci_user
        <set>
            <if test="phone!=null and phone!=''">
                phone = #{phone},
            </if>
            <if test="password!=null and password!=''">
                password = #{password},
            </if>
            <if test="longitude!=null and longitude!=''">
                longitude = #{longitude},
            </if>
            <if test="latitude!=null and latitude!=''">
                latitude = #{latitude},
            </if>
            <if test="certificationStatus!=null and certificationStatus!=''">
                certification_status = #{certificationStatus},
            </if>
            <if test="carStatus!=null and carStatus!=''">
                car_status = #{carStatus},
            </if>
            <if test="userStatus!=null and userStatus!=''">
                user_status = #{userStatus},
            </if>
            <if test="robotStatus!=null and robotStatus!=''">
                robot_status = #{robotStatus},
            </if>
        </set>
        WHERE id = #{id}
    </update>
    <!--查询用户认证列表-->
    <select id="getUserCertification"
            resultType="com.wisewin.backend.entity.bo.UserCertificationBO">
        select ci_user_certification.*,sys_admin.name as adminName,
        u.create_time as userCreateTime,u.phone
        from ci_user_certification,sys_admin,ci_user as u
        where sys_admin.id=ci_user_certification.admin_id and u.id=ci_user_certification.user_id
        <if test="status!=null and status!=''">
            and ci_user_certification.status=#{status}
        </if>
        order by update_time desc
        <include refid="limit"/>
    </select>
    <!--查询用户认证数量-->
    <select id="getUserCertificationCount" parameterType="java.lang.String"
            resultType="java.lang.Integer">
        select count(1)
        from ci_user_certification,sys_admin,ci_user as u
        where sys_admin.id=ci_user_certification.admin_id and u.id=ci_user_certification.user_id
        <if test="status!=null and status!=''">
            and ci_user_certification.status=#{status}
        </if>
    </select>

    <!--修改用户审核状态-->
    <update parameterType="com.wisewin.backend.entity.bo.UserCertificationBO" id="updUserCertificationStatus">
        update ci_user_certification
        <set>
            <if test="demoId!=null and demo_id!=''">
                demo_id=#{demoId},
            </if>
            <if test="status!=null and status!=''">
                status=#{status},
            </if>
            remark=#{remark},
            update_time=now()
        </set>
        where id=#{id}
    </update>

    <select id="getUserAllCount" resultType="java.lang.Long">
        select count(1) from ci_user where robot_status='no'
    </select>

    <select id="getUserRegisteredCount" resultType="com.wisewin.backend.entity.bo.StatisticalBO">
        select count(1) as value
        <if test="type=='year'">
            ,extract(year from create_time) as year
        </if>
        <if test="type=='month'">
            ,extract(year from create_time) as year
            ,extract(month from create_time) as month
        </if>
        <if test="type=='day'">
            ,extract(year from create_time) as year
            ,extract(month from create_time) as month
            ,extract(day from create_time) as day
        </if>

        from ci_user where robot_status='no'

        <if test="type=='day' or type=='month'">
            and extract(year from create_time)=#{year}
        </if>
        <if test="type=='day'">
            and extract(month from create_time)=#{month}
        </if>

        <if test="type=='year'">
            group by year
        </if>
        <if test="type=='month'">
            group by year,month
        </if>
        <if test="type=='day'">
            group by year,month,day
        </if>
    </select>

    <select id="getUserActiveCount" resultType="com.wisewin.backend.entity.bo.StatisticalBO">
        select count(1) as value
        <if test="type=='year'">
            ,extract(year from create_time) as year
        </if>
        <if test="type=='month'">
            ,extract(year from create_time) as year
            ,extract(month from create_time) as month
        </if>
        <if test="type=='day'">
            ,extract(year from create_time) as year
            ,extract(month from create_time) as month
            ,extract(day from create_time) as day
        </if>

        from ci_user_active
        <where>
            <if test="type=='day' or type=='month'">
                and extract(year from create_time)=#{year}
            </if>
            <if test="type=='day'">
                and extract(month from create_time)=#{month}
            </if>
        </where>

        <if test="type=='year'">
            group by year
        </if>
        <if test="type=='month'">
            group by year,month
        </if>
        <if test="type=='day'">
            group by year,month,day
        </if>
    </select>

    <select id="getMatchingCount" resultType="com.wisewin.backend.entity.bo.StatisticalBO">
        select model as name,count(1) as value from ci_matching_friended
        where extract(year from create_time)=#{year}
        <if test="type=='month' or type=='day'">
            and extract(month from create_time)=#{month}
        </if>
        <if test="type=='day'">
            and extract(day from create_time)=#{day}
        </if>
        group by model
    </select>






    <insert id="addTestUser"  parameterType="com.wisewin.backend.entity.dto.UserDTO" useGeneratedKeys="true"
            keyProperty="id">
        INSERT INTO ci_user("phone", "password", "create_time", "latitude", "longitude", "certification_status", "car_status", "user_status", "robot_status", "where_is", "driver" )
        VALUES (#{phone},#{password}, NOW(), #{latitude},#{longitude},#{certificationStatus},#{carStatus},#{userStatus},#{robotStatus},#{whereIs},#{driver});
    </insert>

    <insert id="addTestModel" parameterType="com.wisewin.backend.entity.dto.ModelDTO" useGeneratedKeys="true"
            keyProperty="id" >
          INSERT INTO "ci_model"( "model", "describe", "sex", "sex_count", "birthday", "constellation", "height", "weight",
          "education", "birthplace", "search_distance", "search_sex", "search_age", "sex_status", "car_certification_status",
          "be_like_count", "be_super_like_count", "super_like_count", "super_like_count_time", "be_shielding_count",
           "user_id", "name", "first", "record", "slide_time", "slide_count")
          VALUES (#{model},#{describe}, #{sex}, #{sexCount}, #{birthday},#{constellation}, #{height},#{weight},
           #{education},#{birthplace}, #{searchDistance},#{searchSex}, #{searchAge},#{sexStatus},#{carCertificationStatus},
            #{beLikeCount},#{beSuperLikeCount},#{superLikeCount}, #{superLikeCountTime},#{beShieldingCount},
             #{userId},#{name},#{first},#{record},#{slideTime},#{slideCount});
    </insert>


    <insert id="addTestImg"  parameterType="com.wisewin.backend.entity.dto.PictureDTO" >
        INSERT INTO ci_user_picture( "model_id", "picture_url", "sort", "picture_status", "create_time", "update_time")
        VALUES (#{modelId},#{pictureUrl},#{sort},#{pictureStatus},NOW(),#{updateTime});
    </insert>

    <insert id="addTestInterest" parameterType="com.wisewin.backend.entity.dto.InterestDTO" >
        INSERT INTO ci_user_interest("model_id", "type_id", "interest_name") VALUES (#{modelId},#{typeId},#{interestName});
    </insert>


    <insert id="addTestIncident" parameterType="com.wisewin.backend.entity.dto.IncidentDTO" >
        INSERT INTO "ci_car_incident"("user_id", "origin", "destination", "incident_time", "incident",
         "incident_status", "create_time", "update_time")
         VALUES (#{userId},#{origin},#{destination}, #{incidentTime}, #{incident}, #{incidentStatus},NOW(),#{updateTime});
    </insert>

    <update id="testOption" >
        UPDATE ci_user SET  where_is = ST_POINT(longitude, latitude )
    </update>

    <update id="updUserPOINT" parameterType="java.lang.Long">
        UPDATE ci_user SET  where_is = ST_POINT(longitude,latitude )  where id = #{userId}
    </update>

</mapper>