<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 【管理员】 -->
<mapper namespace="com.wisewin.backend.dao.AdminDAO">

    <resultMap type="com.wisewin.backend.entity.bo.MenuBO" id="menuResult">
        <id column="id" property="id"/>
        <result column="menu_name" property="menuName"/>
        <result column="pid" property="pid"/>
        <result column="status" property="status"/>
        <result column="url" property="url"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        <!-- 多对一的关系 -->
        <!-- property: 指的是属性的值, javaType：指的是属性的类型-->
        <!--<association property="menuBO" javaType="com.wisewin.backend.entity.bo.MenuBO" column="pid" select="get">
        </association>-->
        <collection property="ch" ofType="com.wisewin.backend.entity.bo.MenuBO" column="id" select="getCh">
        </collection>
    </resultMap>

    <!--<select id="get" resultMap="cateResult">
        select * from cate where id=#{id}
    </select>-->
    <select id="getCh" parameterType="java.lang.Long" resultMap="menuResult">
        select * from ce_menu where pid=#{pid};
    </select>


    <!--根据手机号查找管理员信息-->
    <select id="queryAdminInfoByMobile" parameterType="String" resultType="com.wisewin.backend.entity.bo.AdminBO">
        SELECT *
        FROM ce_admin WHERE phone_number = #{mobile}
    </select>
    <!--添加管理员信息(管理員注冊)-->
    <insert id="adminRegister" parameterType="com.wisewin.backend.entity.bo.AdminBO" useGeneratedKeys="true"
            keyProperty="id">
        INSERT INTO ce_admin  SET NAME = #{name},
        phone_number = #{phoneNumber},
        gender = #{gender},
        PASSWORD=#{password},
        create_time=#{createTime},
        STATUS=#{status},
        role_id=#{roleId},
        update_time=#{updateTime}
    </insert>
    <!-- 查找手机号是否注册过  -->
    <select id="selectCountByMobile" parameterType="String" resultType="int">
        SELECT count(id) FROM ce_admin WHERE phone_number = #{mobile}
    </select>

    <!-- 查找用户名是否注册过  -->
    <select id="selectCountByname" parameterType="String" resultType="int">
        SELECT count(name) FROM ce_admin WHERE phone_number = #{mobile}
    </select>

    <!-- 添加角色信息  -->
    <insert id="addRole" parameterType="com.wisewin.backend.entity.bo.RoleBO" useGeneratedKeys="true"
            keyProperty="id">
        INSERT INTO ce_role  SET role_name = #{roleName},
        create_time=#{createTime},
        update_time=#{updateTime}
    </insert>
    <!--  查询所有角色  -->
    <select id="getRoleList" resultType="com.wisewin.backend.entity.bo.RoleBO">
        SELECT id,role_name FROM ce_role
    </select>
    <!--  查询所有权限  -->
    <select id="getMenuList" resultType="com.wisewin.backend.entity.bo.MenuBO">
        SELECT * FROM ce_menu
    </select>
    <!--  给角色赋予权限  -->
    <insert id="addRoleMenu" parameterType="com.wisewin.backend.entity.bo.RoleMenuBO" useGeneratedKeys="true"
            keyProperty="id">
        INSERT INTO ce_role_menu  SET
        role_id=#{roleId},
        menu_id=#{menuId},
        create_time=#{createTime},
        update_time=#{updateTime}
    </insert>

    <!--  根据用户id查询所对应的权限  -->
    <select id="getAdminToMenu" resultType="com.wisewin.backend.entity.bo.MenuBO" parameterType="java.lang.Integer">
        SELECT p.`id`,p.`menu_name`,p.`url`,p.`status`
        FROM
          ce_menu p,ce_role_menu rp,ce_role r
        WHERE
          r.id=rp.role_id AND rp.menu_id=p.id AND  r.id
        IN
            (SELECT r.id
            FROM
               ce_admin u,ce_role r
            WHERE
              u.`id` =#{userId} AND u.`role_id`=r.`id`);
    </select>


    <!--  添加权限信息  -->
    <insert id="addMenuByPid" parameterType="com.wisewin.backend.entity.bo.MenuBO" useGeneratedKeys="true"
            keyProperty="id">
        INSERT INTO ce_menu  SET
        menu_name=#{menuName},
        status=#{status},
        pid=#{pid},
        url=#{url},
        create_time=#{createTime},
        update_time=#{updateTime}
    </insert>

    <!--  查询某角色所对应的权限  -->
    <select id="selectRoleToMenu" parameterType="String" resultType="com.wisewin.backend.entity.dto.MenuDTO">
        SELECT r.`role_name`,p.`menu_name`,r.`id`,p.`id`
        FROM
          ce_menu p,ce_role_menu rp,ce_role r
        WHERE
          r.`role_name`=#{roleName} AND r.id=rp.role_id AND rp.menu_id=p.id;
    </select>

    <!--  根据角色id查询所对应的权限  -->
    <select id="selectRoleMenuById" parameterType="String" resultType="com.wisewin.backend.entity.dto.MenuDTO">
        SELECT r.`role_name`,p.`menu_name`,r.`id`,p.`id`
        FROM
        ce_menu p,ce_role_menu rp,ce_role r
        WHERE
        r.`role_id`=#{roleId} AND r.id=rp.role_id AND rp.menu_id=p.id;
    </select>

    <!--  模糊查询角色信息  -->
    <select parameterType="String" resultType="com.wisewin.backend.entity.dto.MenuDTO" id="getDimRoleMenu">
        SELECT r.`role_name`,p.`menu_name`,r.`id`,p.`id`
        FROM
          ce_menu p,ce_role_menu rp,ce_role r
        WHERE
          r.`role_name` LIKE concat(concat('%',#{dimName}),'%') AND r.id=rp.role_id AND rp.menu_id=p.id;
    </select>

    <!--  根据角色id删除角色信息  -->
    <delete id="delRoleById" parameterType="Integer">
      DELETE  FROM  ce_role WHERE id=#{roleId}
    </delete>

    <!--  查询所有角色所对应的权限  -->
    <select id="getRoleMenu" parameterType="com.wisewin.backend.entity.dto.MenuDTO">
        SELECT r.`role_name`,p.`menu_name`,r.`id`,p.`id`
        FROM
          ce_menu p,ce_role_menu rp,ce_role r
        WHERE r.id=rp.role_id AND rp.menu_id=p.id;
    </select>

    <!--  获取用户对应的角色  -->
    <select id="getAdminRoleByName" parameterType="java.lang.String" resultType="com.wisewin.backend.entity.dto.AdminRoleDTO">
        SELECT
        u.id,r.id,u.name,r.`role_name` ,u.phone_number,u.gender
        FROM
        ce_admin u,ce_role r
        WHERE 1=1
        <if test="_parameter != null">
            AND u.name LIKE concat(concat('%',#{userName}),'%') AND u.role_id=r.id;
        </if>
        <if test="_parameter == null">
            and u.role_id=r.id;
        </if>
    </select>

    <!--  编辑用户所对应的角色  -->
    <update id="editUserRole">
      UPDATE ce_admin SET role_id=#{roleId} WHERE id=#{id}
    </update>

    <!--  根据用户id删除信息  -->
    <delete id="delAdminById" parameterType="Integer">
        DELETE  FROM  ce_admin WHERE id=#{id}
    </delete>

</mapper>